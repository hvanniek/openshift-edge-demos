# Placement with ACM and Placement API

In this section we are going to see how we can manage the placement of APPs using the integration between Advance Cluster Management and Argo CD. Thanks to this integration when you import a new OpenShift Cluster in ACM, this cluster will be available in the Argo CD Controller and, using one of the `ApplicationSet` Generators that we reviewed (in this case the [Cluster Decision Resource Generator](https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators-Cluster-Decision-Resource/)), ACM can manage where to target the APP deployment.

In order to simplify the usage of the [Cluster Decision Resource Generator](https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators-Cluster-Decision-Resource/), ACM provides an API called [Placement API](https://open-cluster-management.io/concepts/placement/) that permits to design the desired placement behaviour by configuring a new `Placement` Object.

As part of the demo environment bootstrap, various object were generated to configure the integration between Advance Cluster Management and Argo CD. One of this objects was the following `Placement` manifest:

```yaml
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Placement
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  name: demo-placement
  namespace: openshift-gitops
spec:
  clusterSets:
    - cloud
    - edge
  numberOfClusters: 1
  predicates:
    - requiredClusterSelector:
        claimSelector:
          matchExpressions:
            - key: demo.status
              operator: In
              values:
                - good
                - average
  prioritizerPolicy:
    configurations:
      - scoreCoordinate:
          builtIn: ResourceAllocatableCPU
        weight: 2
      - scoreCoordinate:
          builtIn: ResourceAllocatableMemory
        weight: 2
```

There are three main points in this decriptor:

* `clusterSets`: Where we indicate the "groups" of clusters configured in ACM that are part of the placement Scheduling

* `predicates`: Where we filter clusters out from those groups, in this case based on cluster metadata generated by a `ClusterClaim` object

* `prioritizerPolicy`: That we use to decide where we will deploy if the `numberOfClusters` is less than the number of available clusters.

So, based in the configuration above, We will select one single cluster (`numberOfClusters: 1`) from the clusters of the `clusterSets` "cloud" and "edge" that have the metadata `demo.status` equal to "good" or "average", and in case that there are more than just one, pick the one with more CPU and Memory available.

In this case, I simulated that an external system is including tags into the OpenShift cluster using a `ClusterClaim`, depending if it determinies that the cluster is in good state, or if it has some faults but it's ok to work or if it is in bad state. During the demo we will act as that external system changing manually those tags by modifying the `ClusterClaim` object.

  > **NOTE**
  >
  > This is an example. You have [more options](https://open-cluster-management.io/concepts/placement/) that can be configured, for example, you can select the cluster out from the `clustersets` simply by labeling the clusters that you want to use, or you can create subgroups of clusters and choose how many deployments of the APP you want per one of each group with the `decisionStrategy` section.

In a previous step you already imported the clusters in to ACM, and you also assigend them to the corresponding `clusterSet`, so you can proceed with the next demo steps.


## Deploy on Cloud

First lets determine the simulated status of the cluster. Since we are talking about "deploying on the cloud", we will mark cloud cluster as "good" (or "ok") state and the the edge clusters as "bad":

1. Access your OpenShift console in the **Hub cluster**.
2. Click the `+` button to add resources.
3. Paste the following content:

    ```yaml
    apiVersion: cluster.open-cluster-management.io/v1alpha1
    kind: ClusterClaim
    metadata:
      name: demo.status
    spec:
      value: good
    ```
4. Access your **Edge OpenShift** clusters:
5. Click the `+` button to add resources.
6. Paste the following content:
    ```yaml
    apiVersion: cluster.open-cluster-management.io/v1alpha1
    kind: ClusterClaim
    metadata:
      name: demo.status
    spec:
      value: good
    ```

  > **NOTE**
  >
  > We are creating these objects becase those were not generated during the lab bootstrap. From now on, you don't create them again, you will need to modify them.

Ok, now that we have prepared the initial state of our clusters, we can deploy the application:

1. Access your OpenShift console in the **Hub cluster**.
2. Click the `+` button to add resources.
3. Paste the following content:

    ```yaml
    apiVersion: argoproj.io/v1alpha1
    kind: ApplicationSet
    metadata:
      labels:
        app.kubernetes.io/managed-by: demo-placement-global
      name: demo-placement-global
      namespace: openshift-gitops
    spec:
      generators:
        - matrix:
            generators:
              - git:
                  directories:
                    - path: demos/placement/apps/welcome/*
                  repoURL: 'https://github.com/luisarizmendi/openshift-edge-demos.git'
                  revision: main
              - clusterDecisionResource:
                  configMapRef: acm-placement
                  labelSelector:
                    matchLabels:
                      cluster.open-cluster-management.io/placement: demo-placement
                  requeueAfterSeconds: 180
      goTemplate: true
      goTemplateOptions:
        - missingkey=error
      template:
        metadata:
          labels:
            app.kubernetes.io/managed-by: demo-placement-global
          name: '{{.path.basename}}-{{.name}}'
        spec:
          destination:
            namespace: '{{.path.basename}}'
            server: '{{.server}}'
          project: demo-placement
          source:
            helm:
              valueFiles:
                - values.yaml
                - environment/values-{{.name}}.yaml
            path: '{{.path.path}}'
            repoURL: 'https://github.com/luisarizmendi/openshift-edge-demos.git'
            targetRevision: main
          syncPolicy:
            automated:
              prune: true
              selfHeal: true
    ```

The `ApplicationSet` object above is using two generators, like in the previous demo section. The first one is a "Git generator" to generate `Application` manifests based on directories in a Git repository. The second one is the `clusterDecisionResource` generator, that as commented before, generates an intermediate object (in this case is called `PlacementDecession`) that determines the target clusters.

It also selects the `Placement` created before by adding a maching label `cluster.open-cluster-management.io/placement: demo-placement` requirement.

You will see how the "hello" APP is deployed on the Cloud OpenShift (`local-cluster`).


## Deploy on Edge














cambiar numero de clusters a dos






## Dynamic reasigment











## Clean-Up

Once you have finished moving the app around your clusters, you can delete the `Application` and `ApplicationSet` objects:

1. Access your OpenShift console in the Hub cluster.
2. Click the `+` button to add resources.
3. Paste the following content:

    ```yaml
    apiVersion: batch/v1
    kind: Job
    metadata:
      generateName: cleanup-demo-placement-global-
      namespace: openshift-gitops
    spec:
      template:
        spec:
          serviceAccountName: openshift-gitops-argocd-application-controller
          containers:
            - name: delete-apps
              image: openshift/origin-cli:latest
              command: ["oc"]
              args: ["delete", "applications", "-n", "openshift-gitops", "-l", "app.kubernetes.io/managed-by=demo-placement-global"]
            - name: delete-appsets
              image: openshift/origin-cli:latest
              command: ["oc"]
              args: ["delete", "applicationsets", "-n", "openshift-gitops", "-l", "app.kubernetes.io/managed-by=demo-placement-global"]
          restartPolicy: Never
    ```

## Going beyond


