# Placement with Helm and Argo CD Application manifests

The idea of this approach is to have a "parent" `Application` object that generates other `ApplicationSet` manifests (one per cluster) using Helm templates. That generated `ApplicationSet` will create the corresponding `Application` manifest objects, in this case generated by a `generator`  based on the directories where we place the APP resources.

```
                                                                                  --> Child Application (dir 1)
                                                                                 /
                               --> Child ApplicationSet Cluster 1 ---(generator) ----> Child Application (dir 2)
                             /                                                   \
                             |                                                    --> Child Application (dir "n")
                             | 
                             | 
                             |                                                    --> Child Application (dir 1)
                             |                                                   /                             
Parent Application ---(Helm) ----> Child ApplicationSet Cluster 2 ---(generator) ----> Child Application (dir 2)
                             |                                                   \
                             |                                                    --> Child Application (dir "n")
                             | 
                             |                              
                             |                                                      --> Child Application (dir 1)
                             \                                                     /
                               --> Child ApplicationSet Cluster "n" ---(generator) ----> Child Application (dir 2)
                                                                                   \
                                                                                    --> Child Application (dir "n")
```

This approach provides the great flexibility that you obtain when you use Helm templating to create any Kubernetes manifest. You can modify the server URL along with other values such as paths, names, etc.

Attending to the Helm [values](../../sections/01-helm/resources/00-argocd-app/values.yaml) and the [template](../../sections/01-helm/resources/00-argocd-app/templates/application.yaml) used as the base for this demo.

At the begining of the demo, you will have uncommented in the [values](../../sections/01-helm/resources/00-argocd-app/values.yaml) files only the Cloud (Hub) Cluster. Then during the steps you will start modifying these values in the Git repository and see how changes are reflected on the APPs deployed using Argo CD.


## Deploy on Cloud

In order to deploy the child applications you need to create the parent application object targeting the location of the Helm Chart that creates the child application manifests:

   - Access your OpenShift console in the Hub cluster.
   - Click the `+` button to add resources.
   - Paste the following content changing the `repoURL` to point to your own repo:

        ```yaml
        apiVersion: argoproj.io/v1alpha1
        kind: Application
        metadata:
        name: demo-placement-global
        namespace: openshift-gitops
        labels:
            app.kubernetes.io/managed-by: demo-placement-global
        spec:
        project: demo-placement

        source:
            repoURL: 'https://<YOUR REPO>.git'
            targetRevision: main
            path: demos/placement/sections/01-helm/resources/00-argocd-app

        destination:
            server: 'https://kubernetes.default.svc'

        syncPolicy:
            automated:
            prune: true
            selfHeal: true
        ```

After few seconds, you will find in the Argo CD Web UI that, along with the `demo-placement-global` that you just created, you have the `hello-local-cluster` Child Application (which means that the "hello" APP is being deployed in the "local-cluster" OpenShift cluster)

  > **Note**
  > 
  > Please note that the `ApplicationSet` objects are not shown in the Argo CD UI


<image>


## Deploy on Edge

Now it is time to make changes in the [values](../../sections/01-helm/resources/00-argocd-app/values.yaml) to remove the "hello" APP from the "Cloud" cluster and run it on "Edge" clusters.

You can `pull` the repository local into your laptop but for convenience, for the demo, we will change the values directly in GitHub:

   - Edit the values file in your GitHub repository (`demos/placement/sections/01-helm/resources/00-argocd-app/values.yaml`).
   - You will find commneted a couple of example of cluster descriptions. Add your Edge clusters and comment the `local-cluster` entry.
   - If you don't want to wait, open the Argo CD UI and click `REFRESH APPS`.

You will see how the "hello" APP deployed in the `local-cluster` starts being deleted and, at the same time, that the APP is being deployed in the speficied clusters in the `values` file.


## Clean-Up

Once you have finished playing moving the APP around your clusters, you can delete the `Application` and `ApplicationSets` objects:

   - Access your OpenShift console in the Hub cluster.
   - Click the `+` button to add resources.
   - Paste the following content:

        ```yaml
        apiVersion: batch/v1
        kind: Job
        metadata:
          generateName: cleanup-demo-placement-global-
          namespace: openshift-gitops
        spec:
          template:
            spec:
              serviceAccountName: openshift-gitops-argocd-application-controller
              containers:
                - name: delete-apps
                  image: openshift/origin-cli:latest
                  command: ["oc"]
                  args: ["delete", "applications", "-n", "openshift-gitops", "-l", "app.kubernetes.io/managed-by=demo-placement-global"]
                - name: delete-appsets
                  image: openshift/origin-cli:latest
                  command: ["oc"]
                  args: ["delete", "applicationsets", "-n", "openshift-gitops", "-l", "app.kubernetes.io/managed-by=demo-placement-global"]
              restartPolicy: Never
        ```